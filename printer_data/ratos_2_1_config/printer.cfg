#############################################################################################################
### CONFIGURATION GENERATED BY THE RATOS CONFIGURATOR
#############################################################################################################
#[include RatOS.cfg]  # this is the unmodified RaatOS configuration
[include RatOS_modified.cfg]

#############################################################################################################
### MACRO CONFIGURATION
### Configure the behavior of RatOS macros
### See: https://os.ratrig.com/docs/configuration/macros
#############################################################################################################
[gcode_macro RatOS]
variable_relative_extrusion: False
variable_preheat_extruder: True
variable_calibrate_bed_mesh: True
variable_nozzle_priming: "primeblob"
variable_start_print_park_in: "back"
variable_start_print_park_z_height: 50
variable_end_print_park_in: "back"
variable_pause_print_park_in: "back"
variable_macro_travel_speed: 600
variable_macro_travel_accel: 8000
# Euclid macros
variable_stowable_probe_position_preflight: [ 27, 30 ]
variable_stowable_probe_position_side:      [ 27, 0  ]
variable_stowable_probe_position_dock:      [  7, 0  ]
variable_stowable_probe_position_exit:      [  7, 30 ]
# Adaptive meshing
variable_adaptive_mesh: True

#############################################################################################################
### USER OVERRIDES & CUSTOM CONFIGURATION
### Anything custom you want to add, or RatOS configuration you want to override, do it here.
### This section is pre-populated with the most common settings you may want to change.
### See: https://os.ratrig.com/docs/configuration/includes-and-overrides
###
### It is recommended that you follow these steps to properly calibrate your printer:
### 0) Sanity check and PID Tuning: https://www.klipper3d.org/Config_checks.html
### 1) Z-offset calibration: https://www.klipper3d.org/Probe_Calibrate.html#calibrating-probe-z-offset
### 2) Pressure Advance: https://www.klipper3d.org/Pressure_Advance.html
### 3) Skew Correction: https://www.klipper3d.org/Skew_Correction.html
### 4) Resonance Compensation: https://www.klipper3d.org/Resonance_Compensation.html
### RatOS has dedicated macro's to generate shaper graphs for deeper analysis (requires accelerometer).
### Use MEASURE_COREXY_BELT_TENSION to compare tension between belts, and use
### GENERATE_SHAPER_GRAPHS to generate the resonance graphs for analysing and manually entering input shaper
### configuration.
### You can run SHAPER_CALIBRATE to automatically calibrate your input shaper configuration, if you just want
### to get started.
### Additionally, you can use the Realtime Analysis Tool to analyze your printer's performance in real-time.
### Read more about klipper here: https://www.klipper3d.org/Overview.html
#############################################################################################################

#---------------------------------------------------- X -----------------------------------------------------
# The A motor in the CoreXY system, located at the rear left of the printer
# Connected to MOTOR 0 on Octopus Pro 446
#------------------------------------------------------------------------------------------------------------
[stepper_x]
dir_pin: !x_dir_pin                 # Add ! in front of pin name to reverse the direction of stepper_x
rotation_distance: 40              # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
homing_speed: 50
position_min: 0
position_max: 400
position_endstop: 0

#---------------------------------------------------- Y -----------------------------------------------------
# The B motor in the CoreXY system, located at the rear right of the printer
# Connected to MOTOR 1 on Octopus Pro 446
#------------------------------------------------------------------------------------------------------------
[stepper_y]
dir_pin: !y_dir_pin                 # Add ! in front of pin name to reverse the direction of stepper_y
rotation_distance: 40              # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
homing_speed: 50
position_min: 0
position_max: 400
position_endstop: 400

#---------------------------------------------------- Z -----------------------------------------------------
# The left Z motor for the kinematic bed
# Connected to MOTOR 5 on Octopus Pro 446
#------------------------------------------------------------------------------------------------------------
[stepper_z]
dir_pin: !z0_dir_pin               # Remove ! in front of pin name to reverse the direction of stepper_z
rotation_distance: 4               # 4 for TR8*4 lead screws
homing_speed: 10
position_min: -5
position_max: 400

#---------------------------------------------------- Z1 ----------------------------------------------------
# The rear Z motor for the kinematic bed
# Connected to MOTOR 6 on Octopus Pro 446
#------------------------------------------------------------------------------------------------------------
[stepper_z1]
dir_pin: !z1_dir_pin               # Remove ! in front of pin name to reverse the direction of stepper_z1
rotation_distance: 4               # 4 for TR8*4 lead screws

#---------------------------------------------------- Z2 ----------------------------------------------------
# The right Z motor for the kinematic bed
# Connected to MOTOR 7 on Octopus Pro 446
#------------------------------------------------------------------------------------------------------------
[stepper_z2]
dir_pin: !z2_dir_pin               # Remove ! in front of pin name to reverse the direction of stepper_z2
rotation_distance: 4               # 4 for TR8*4 lead screws

#------------------------------------------------- EXTRUDER -------------------------------------------------
# The extruder motor used for pushing filament through the toolhead
# Connected to EBB36 v1.2
#------------------------------------------------------------------------------------------------------------
[extruder]
dir_pin: toolboard_t0:e_dir_pin   # Remove ! in front of pin name to reverse the direction of extruder
rotation_distance: 4.63            # Orbiter 2 default
#pressure_advance: 0.05            # Check https://www.klipper3d.org/Pressure_Advance.html for pressure advance tuning.
#control: pid
#pid_kp: 28.413
#pid_ki: 1.334
#pid_kd: 151.300


[heater_bed]
#control: pid
#pid_Kp: 22.2
#pid_Ki: 1.08
#pid_Kd: 114

# Probe configuration
[probe]
#z_offset: 11.330 # Will be commented out after a successful PROBE_CALIBRATE and SAVE_CONFIG
pin: ^toolboard_t0:probe_pin# For NPN NC probes such as the Super Pinda / Vinda / SupCR / Decoprobe probes.
#pin: ^!toolboard_t0:probe_pin # NPN NO (refer to the specs of your probe)
#pin: toolboard_t0:probe_pin # PNP NO (refer to the specs of your probe)
#pin: !toolboard_t0:probe_pin # PNP NC (refer to the specs of your probe)


#############################################################################################################
### USER OVERRIDES
### Anything custom you want to add, or RatOS configuration you want to override, do it here.
#############################################################################################################

[mcu toolboard_t0]
canbus_uuid: 2263dd046341    #v1.2 EBB36
canbus_interface: can0

[bed_mesh]
horizontal_move_z: 15

[fan]
shutdown_speed: 0
kick_start_time: 0.3   #Time (in seconds) to run the fan at full speed when either first enabling or increasing it by more than 50% 
cycle_time: 0.01


#############################################################################################################
### Exclude objects
### https://docs.mainsail.xyz/overview/features/exclude-objects
#############################################################################################################
[exclude_object]


#############################################################################################################
### Enclosure heater
### 
#############################################################################################################
[temperature_sensor Enclosure_Top]
sensor_type: Generic 3950
sensor_pin: PF4

#[temperature_sensor Enclosure_Bottom]
#sensor_type: Generic 3950
#sensor_pin: PF7

[heater_generic chamber]
heater_pin: PB10
max_power: 0.25
sensor_type: Generic 3950
sensor_pin: PF7
control: watermark
max_delta: 5.0
min_temp: -100
max_temp: 105
gcode_id: D

[verify_heater chamber]
max_error: 1000000
check_gain_time: 1000000

[heater_fan PTC_fan]
pin: PD15
heater: chamber
heater_temp: 35.0


#############################################################################################################
### Electronics control fans
### 
### 2x 120mm slim fans, with tacho pin
#############################################################################################################
[temperature_fan electronics_fan]
#[controller_fan controller_fan]
# 4-pin computer PWM exhaust fan - FAN5
pin: PD14
control: pid
pid_Kp: 40
pid_Ki: 0.2
pid_Kd: 0.1
max_power: 1.0
min_speed: 0
max_speed: 1
shutdown_speed: 0.0
kick_start_time: 2.0
target_temp: 30

# The thermistor that measures the temp for this temp-controlled fan:
sensor_type: Generic 3950
sensor_pin: PF6
min_temp: 5
max_temp: 100
gcode_id: C

# if your controller doesn't support hardware_pwm then try leaving these two lines out:
hardware_pwm: True
cycle_time: 0.00004 # 25 kHz

# RPM monitoring:
tachometer_pin: ^PG10
tachometer_poll_interval: 0.0005
tachometer_ppr: 2


#############################################################################################################
### BTT Smart Filament Sensor
### Github: https://github.com/bigtreetech/smart-filament-detection-module
#############################################################################################################
[filament_motion_sensor filament_sensor] 
detection_length: 7     # The minimum length of filament pulled through the sensor to trigger a state change on the switch_pin Default is 7 mm.
extruder: extruder      # The name of the extruder section this sensor is associated with.This parameter must be provided.
switch_pin: ^PG11       # Changing the switch_pin name according to your motherboard. ^ pulls the pin up to avoid false positives
pause_on_runout: True
#runout_gcode:
#insert_gcode:
#event_delay:



#############################################################################################################
### Chamber Lighting
### 24v COB light strip connected to an empty heater port (HE3)
#############################################################################################################
[output_pin caselight]
pin: PB11
#max_power: 1.0
#kick_start_time: 0.5
pwm: true
shutdown_value: 0
value: 100
cycle_time: 0.005
scale: 100

# Lighting Control
[gcode_macro LIGHTS_OFF]
gcode:
    SET_PIN PIN=caselight VALUE=0

[gcode_macro LIGHTS_ON]
gcode:
    SET_PIN PIN=caselight VALUE=100

[gcode_macro LIGHTS_10]
gcode:
    SET_PIN PIN=caselight VALUE=10

[gcode_macro LIGHTS_50]
gcode:
    SET_PIN PIN=caselight VALUE=50

[gcode_macro LIGHTS_TOGGLE]
gcode:
    {% if printer['output_pin caselight'].value > 0 %}
    LIGHTS_OFF
    {% else %}
    LIGHTS_ON
    {% endif %}

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 19.030
#*# pid_ki = 1.425
#*# pid_kd = 63.512
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 63.915
#*# pid_ki = 1.761
#*# pid_kd = 580.027
#*#
#*# [probe]
#*# z_offset = 11.210
#*#
#*# [bed_mesh ratos]
#*# version = 1
#*# points =
#*# 	  0.014687, -0.010000, -0.007500
#*# 	  0.007812, -0.006563, 0.009062
#*# 	  0.001250, 0.010625, 0.018125
#*# x_count = 3
#*# y_count = 3
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = lagrange
#*# tension = 0.2
#*# min_x = 163.248
#*# max_x = 223.908
#*# min_y = 181.12
#*# max_y = 218.88
